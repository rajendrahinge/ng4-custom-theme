!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/core"),require("rxjs/Observable"),require("rxjs/ReplaySubject"),require("rxjs/add/operator/map"),require("rxjs/add/operator/mergeMap"),require("rxjs/add/operator/pluck"),require("rxjs/add/operator/first"),require("rxjs/add/observable/fromEvent"),require("rxjs/add/observable/merge"),require("rxjs/add/observable/throw"),require("rxjs/add/observable/of")):"function"==typeof define&&define.amd?define(["exports","@angular/core","rxjs/Observable","rxjs/ReplaySubject","rxjs/add/operator/map","rxjs/add/operator/mergeMap","rxjs/add/operator/pluck","rxjs/add/operator/first","rxjs/add/observable/fromEvent","rxjs/add/observable/merge","rxjs/add/observable/throw","rxjs/add/observable/of"],r):r((e.ng=e.ng||{},e.ng.asyncLocalStorage=e.ng.asyncLocalStorage||{}),e.ng.core,e.Rx,e.Rx)}(this,function(e,r,t,o){"use strict";function a(){var e;try{e=new u}catch(r){try{e=new l}catch(r){e=new b}}return new s(e)}var n=function(){function e(){}return e}(),s=function(){function e(e){this.database=e}return e.prototype.getItem=function(e){return this.database.getItem(e)},e.prototype.setItem=function(e,r){return this.database.setItem(e,r)},e.prototype.removeItem=function(e){return this.database.removeItem(e)},e.prototype.clear=function(){return this.database.clear()},e}();s.decorators=[{type:r.Injectable}],s.ctorParameters=function(){return[{type:n}]};var c=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])};return function(r,t){function o(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}(),u=function(e){function r(){var r=e.call(this)||this;return r.dbName="ngStorage",r.objectStoreName="localStorage",r.keyPath="key",r.dataPath="value",r.database=new o.ReplaySubject,r.connect(),r}return c(r,e),r.prototype.getItem=function(e){var r=this;return this.transaction().map(function(r){return r.get(e)}).mergeMap(function(e){var o=t.Observable.fromEvent(e,"success").pluck("target","result").map(function(e){return e?e[r.dataPath]:null});return t.Observable.merge(o,r.toErrorObservable(e,"getter")).first()})},r.prototype.setItem=function(e,r){var o=this;return null==r?t.Observable.of(!0):this.getItem(e).map(function(e){return null==e?"add":"put"}).mergeMap(function(a){return o.transaction("readwrite").mergeMap(function(n){var s;switch(a){case"add":s=n.add((c={},c[o.dataPath]=r,c),e);break;case"put":default:s=n.put((u={},u[o.dataPath]=r,u),e)}return t.Observable.merge(o.toSuccessObservable(s),o.toErrorObservable(s,"setter")).first();var c,u})})},r.prototype.removeItem=function(e){var r=this;return this.getItem(e).mergeMap(function(o){return null!=o?r.transaction("readwrite").mergeMap(function(o){var a=o.delete(e);return t.Observable.merge(r.toSuccessObservable(a),r.toErrorObservable(a,"remover")).first()}):t.Observable.of(!0).first()})},r.prototype.clear=function(){var e=this;return this.transaction("readwrite").mergeMap(function(r){var o=r.clear();return t.Observable.merge(e.toSuccessObservable(o),e.toErrorObservable(o,"clearer")).first()})},r.prototype.connect=function(){var e=this,r=indexedDB.open(this.dbName);t.Observable.fromEvent(r,"upgradeneeded").first().subscribe(function(r){var t=r.target.result;t.objectStoreNames.contains(e.objectStoreName)||t.createObjectStore(e.objectStoreName)});var o=t.Observable.fromEvent(r,"success");t.Observable.merge(o,this.toErrorObservable(r,"connection")).first().subscribe(function(r){e.database.next(r.target.result)})},r.prototype.transaction=function(e){var r=this;return void 0===e&&(e="readonly"),this.database.map(function(t){return t.transaction([r.objectStoreName],e).objectStore(r.objectStoreName)})},r.prototype.toSuccessObservable=function(e){return t.Observable.fromEvent(e,"success").map(function(){return!0})},r.prototype.toErrorObservable=function(e,r){return void 0===r&&(r=""),t.Observable.fromEvent(e,"error").mergeMap(function(){return t.Observable.throw(new Error("IndexedDB "+r+" issue."))})},r}(n);u.decorators=[{type:r.Injectable}],u.ctorParameters=function(){return[]};var i=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])};return function(r,t){function o(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}(),l=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r.localStorage=localStorage,r}return i(r,e),r.prototype.getItem=function(e){var r=this.localStorage.getItem(e);if(null!=r)try{r=JSON.parse(r)}catch(e){return t.Observable.throw(new Error("Invalid data in localStorage."))}return t.Observable.of(r)},r.prototype.setItem=function(e,r){return this.localStorage.setItem(e,JSON.stringify(r)),t.Observable.of(!0)},r.prototype.removeItem=function(e){return this.localStorage.removeItem(e),t.Observable.of(!0)},r.prototype.clear=function(){return this.localStorage.clear(),t.Observable.of(!0)},r}(n);l.decorators=[{type:r.Injectable}],l.ctorParameters=function(){return[]};var p=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])};return function(r,t){function o(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}(),b=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r.localStorage=new Map,r}return p(r,e),r.prototype.getItem=function(e){var r=this.localStorage.get(e);return t.Observable.of(void 0!=r?r:null)},r.prototype.setItem=function(e,r){return this.localStorage.set(e,r),t.Observable.of(!0)},r.prototype.removeItem=function(e){return this.localStorage.delete(e),t.Observable.of(!0)},r.prototype.clear=function(){return this.localStorage.clear(),t.Observable.of(!0)},r}(n);b.decorators=[{type:r.Injectable}],b.ctorParameters=function(){return[]};var f=function(){function e(){}return e}();f.decorators=[{type:r.NgModule,args:[{providers:[{provide:s,useFactory:a}]}]}],f.ctorParameters=function(){return[]},e.AsyncLocalStorageModule=f,e.AsyncLocalStorage=s,Object.defineProperty(e,"__esModule",{value:!0})});